# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Rust SDK for the Hylo Protocol - a collateralized stablecoin and leverage token DEX on Solana.

## Development Environment

This project uses Nix for reproducible development environments.

```bash
nix develop            # Stable Rust 1.88.0
nix develop .#nightly  # Nightly (for polish/lint scripts)
```

### Commands

After completing ANY coding task, ALWAYS run:
```bash
nix develop .#nightly --command ./bin/polish.sh  # Format + auto-fix clippy
nix develop .#nightly --command ./bin/lint.sh    # Verify (CI check mode)
```

Other commands:
```bash
cargo test                    # Run all tests
cargo test -p hylo-quotes     # Run tests for specific crate
cargo +nightly udeps          # Check unused dependencies (nightly shell)
./bin/build.sh                # Full build + tests (excludes hylo-jupiter)
```

Note: `polish.sh` and `lint.sh` enforce `clippy::pedantic` — all pedantic lints must pass.

Integration tests require env vars (`RPC_WS_URL` can be fake):
```bash
RPC_URL=https://mainnet.helius-rpc.com/?api-key=<key>
RPC_WS_URL=wss://mainnet.helius-rpc.com/?api-key=<key>
```

## Crates

| Crate | Purpose |
|-------|---------|
| `hylo-core` | Pure protocol math and types (no RPC) |
| `hylo-idl` | Anchor IDL and type-safe token definitions |
| `hylo-clients` | Transaction builders and execution clients |
| `hylo-quotes` | High-level quoting strategies |
| `hylo-jupiter` | Jupiter AMM integration |

## Code Style

From `rustfmt.toml`:
- 2-space indentation
- 80 character line width
- Import grouping: std → external → internal

Naming:
- Modules/functions: `snake_case`
- Structs/Traits: `PascalCase`
- Constants: `SCREAMING_SNAKE_CASE`
- Generic type params: Single letters (`IN`, `OUT`, `C`, `L`)

### Style Rules (IMPORTANT)

- NEVER use explicit `return` statements - use Rust's expression-oriented style
- NEVER use `for`/`while` loops - always prefer iterator API (`.map()`, `.filter()`, `.fold()`, etc.)
- NEVER use `.unwrap()` or `.expect()` - always use `?` error propagation
- Favor functional style over imperative control flow

### Documentation

- Module docs: `//!` with sections
- Function docs: `///` with `# Errors` section

### Error Handling

- Use `anyhow::Result<T>` for all fallible functions
- Custom errors in `hylo-core/src/error.rs`

## Architecture

### Crate Dependency Flow

```
hylo-core (no hylo deps) → hylo-idl → hylo-clients → hylo-quotes → hylo-jupiter
```

`hylo-core` has an `offchain` feature flag that enables `hylo-idl` and Jupiter AMM interface
dependencies. All downstream crates depend on `hylo-core` with `offchain` enabled.

### Type-Safe Token System

The `TokenMint` trait defines tokens with an associated `Exp` type for decimal precision:
- Tokens: `HYUSD`, `XSOL`, `SHYUSD`, `JITOSOL`, `HYLOSOL`
- Operations are generic over token pairs: `<IN: TokenMint, OUT: TokenMint>`

### Core Traits

| Trait | Purpose |
|-------|---------|
| `TokenOperation<IN, OUT>` | Pure math for computing quotes |
| `InstructionBuilder<IN, OUT>` | Build instructions for token pairs |
| `BuildTransactionData<IN, OUT>` | Full transaction construction |
| `SimulatePrice<IN, OUT>` | Quote via transaction simulation |
| `ProgramClient` | Base trait for exchange/stability pool clients |
| `RuntimeQuoteStrategy` | Unified quoting interface (runtime dispatch via Pubkeys) |

### Quoting Strategies

- `ProtocolStateStrategy` - Fast quotes from cached state (no RPC validation)
- `SimulationStrategy` - Slower but validates via RPC simulation
- `RuntimeQuoteStrategy` is generated by the `runtime_quote_strategies!` macro, which
  creates match arms for all 16 supported token pair routes, dispatching from runtime
  Pubkeys to compile-time typed `QuoteStrategy<IN, OUT, C>` implementations

### Fixed-Point Math

Uses `hylo-fix` crate with `UFix64<Exp>` type:
- Compile-time decimal precision via type parameter (`N6`, `N9`)
- Import via `fix::prelude::*`

## Common Patterns

Building instructions (type-safe, no RPC):
```rust
use hylo_clients::instructions::ExchangeInstructionBuilder as ExchangeIB;

let instructions = ExchangeIB::build_instructions::<JITOSOL, HYUSD>(args)?;
let luts = ExchangeIB::lookup_tables::<JITOSOL, HYUSD>();
```

Computing quotes from protocol state:
```rust
let op = state.output::<JITOSOL, HYUSD>(amount_in)?;
```

Using the prelude:
```rust
use hylo_clients::prelude::*;  // Common imports
use hylo_core::prelude::*;     // Math types
```

## Testing

- State-based tests in `hylo-quotes/tests/state_based_tests.rs` verify pricing against mainnet snapshots
- Integration tests in `hylo-quotes/tests/integration_tests.rs` compare `ProtocolStateStrategy` vs `SimulationStrategy`
- Uses `#[test_context(QuoteStrategyTestContext)]` macro for test setup
- Do NOT use `flaky_test` macro (removed from codebase)

## Notes

- All token operations are compile-time type-checked
- `UFix64` values use `.bits` for raw u64 access
- Slippage is in basis points (50 = 0.5%)
- Default compute units: 100k with buffer
- Jupiter integration uses `HyloJupiterPair<IN, OUT>` generic
- `hylo-jupiter` is excluded from workspace tests (`build.sh` uses `--exclude hylo-jupiter`)
- CI runs lint (nightly shell) then build/test (stable shell), plus version check on PRs
